<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.ultraq.net.nz/thymeleaf/layout "
      layout:decorate="~{layout/layout1}" >

<div layout:fragment="content">

    <div class="panel-heading"><h3>Post list</h3></div>

    <!-- panel -->
    <div class="panel-body">

        <!-- content -->
        <p th:text="${post}"></p>

        <div class='container'>
            <table class="table table-striped table-bordered table-hover">
                <thead>
                <tr>
                    <th>id</th>
                    <th>content</th>
                    <th>nickname</th>
                    <th>reply date</th>
                </tr>
                </thead>
                <tbody id="replyTable">

                </tbody>
            </table>
        </div>

        <div class="pull-right">
            <button class='btn ' id='addReplyBtn'>Add Reply</button>
        </div>

    </div>
    <!-- end panel -->

    <!-- Modal -->
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content -->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>

                    <h4 class="modal-title">Modal Header</h4>
                </div>
                <div class="modal-body">
                    <label>Reply text</label>
                    <input type="text" class="form-control" name="content">
                    <label>Nickname</label>
                    <input type="text" class="form-control" name="nickname">
                </div>
                <div class="modal-footer">
                    <button id="modalBtn" class="btn btn-info">Save</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- end Modal -->

</div>
<!-- end fragment -->

<th:block layout:fragment="script">

    <script th:inLine="javascript" th:src="@{'/js/reply.js'}"></script>

    <script th:inline="javascript">

        $(document).ready(function (e) {

            (function () {
                // load reply
                replyManager.getAll([[${vo.id}]], printList);
            })();

            function printList(list) {
                var str = "";
                var replyObj;
                for (var i = 0; i < list.length; i++) {
                    replyObj = list[i];

                    str += "<tr>" +
                        "<td>" + replyObj.id + "</td>" +
                        "<td>" + replyObj.replyText + "</td>" +
                        "<td>" + replyObj.replyer + "</td>" +
                        "<td>" + formatDate(replyObj.regDate) + "</td>" +
                        "</tr>";
                }
                $("#replyTable").html(str)
            }

            function formatDate(timeValue) {

                var date = new Date(timeValue);
                return date.getFullYear()
                + "-" + (date.getMonth() + 1 >= 10 ? date.getMonth() + 1 : '0' + (date.getMonth() + 1))
                + "-" + date.getDate()
            }

            $("#addReplyBtn").on('click', function () {
                $("#myModal").modal("show");
                $(".modal-title").text("Add Reply");

                mode= "ADD";
            });

        });
        // document ready end

        // comment CURD
        var id = [[${vo.id}]];
        var replyTextObj = $("input[name='replyText']");
        var replyerObj = $("input[name='replyer']");

        // create
        $("#modalBtn").click(function () {

            if (mode === 'ADD') {

                var replyText = replyTextObj.val();
                var replyer = replyerObj.val();
                var obj = {replyText:replyText, replyer:replyer, id:id};

                replyManager.add(obj, function (list) {
                    printList(list);
                    alert("New comment added!")
                    $("#myModal").modal("hide");
                    replyTextObj.val("");
                    replyerObj.val("");
                })
            }
            else if (mod === 'MOD') {

                var obj = {replyText: replyText, id: id, rno: rno};
                replyManager.update(obj, function (list) {

                    alert("Comment has been updated.")
                    afterAll(list);
                })
            }
        })

        var rno;

        $("#replyTable").on("click", "tr", function (e) {
            var tds = $(this).find('td');

            console.log(tds);

            rno = tds[0].innerHTML;
            mode = 'MOD';

            replyTextObj.val(tds[1].innerHTML);
            replyerObj.val(tds[2].innerHTML);
            $("#myModal").modal("show");
            $(".modal-title").text("Modify / Delete Reply");
        })

        $("delModalBtn").on("click", function () {
            var obj = {id:id, rno:rno};

            replyManager.remove(obj, function (list) {

                printList(list);

                alert("Comment deleted.")
                $("#myModal").modal("hide");
                replyTextObj.val("");
                replyerObj.val("");
            });
        });

        function afterAll(list) {
            printList(list);
            $("myModal").modal("hide");
            replyTextObj.val("");
            replyerObj.val("");
        }

    </script>

</th:block>

</html>